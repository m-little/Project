doctype 5
html.all(style="background-image:url('../images/bg1.png');")

	include ../header

	div.all(style="max-width:1000px; margin:auto;")
		div(style="padding-bottom:40px; background-color:white; margin-bottom:10px; border:1px solid #c2c2c2;")

			- if (recipe.public == '0')
				div(style="float:left; clear:both; height:128px; width:24px; position:relative; top:24px; left:-18px; margin-bottom:-140px; background-image:url('../images/private.png');")

			div(id="recipe_pic_prev", style="position:relative; left:-18px; top:66px; width:24px; height:44px; margin-bottom:-46px; background-image:url('../images/prev1.png'); cursor:pointer;", title="Previous photo.", onClick="prev_picture();")
			div(id="recipe_pic_next", style="position:relative; left:19px; top:66px; float:right; width:24px; height:44px; margin-bottom:-46px; background-image:url('../images/next1.png'); cursor:pointer;", title="Next photo.", , onClick="next_picture();")

			//- Recipe Category
			div(style="position:relative; right:10px; top:2px; margin-top:-2px; font-size:28px; float:right; clear:both; width:auto; height:auto; padding-left:16px; padding-right:16px; margin-bottom:-36px; background-color:white; border-bottom-left-radius:.6em; border-bottom-right-radius:.6em; opacity:.8; filter:alpha(opacity=80); cursor:default; z-index:2;", title="Category")
				| #{recipe.category}

			//- Recipe Name
			div(style="position:relative; left:10px; top:2px; margin-top:-2px; font-size:32px; float:left; clear:both; width:auto; height:auto; padding-left:16px; padding-right:16px; margin-bottom:-36px; background-color:white; border-bottom-left-radius:.6em; border-bottom-right-radius:.6em; opacity:.8; filter:alpha(opacity=80); cursor:default; z-index:2;")
				| #{recipe.name}

			//- Image
			div(id="recipe_photo_div", style="width:100%; max-height:auto; min-height:160px; height:160px; overflow:hidden;")
				img(id="recipe_photo", src="../images/user_images/#{recipe.get_picture(0).location}", style="width:100%; position:relative;", alt="#{recipe.get_picture(0).caption}", title="#{recipe.get_picture(0).caption}", onLoad="refresh_picture();")

			div(id="recipe_pic_drag", style="position:relative; right:8px; top:-24px; float:right; width:27px; height:14px; margin-bottom:-46px; background-image:url('../images/drag1.png'); cursor:s-resize; z-index:2;", title="Enlarge this photo. Double click to reset.", onClick="zoom_photo($('#recipe_pic_zoom').position());")

			//- Owner
			div(style="position:relative; left:10px; top:-26px; font-size:16px; float:left; clear:both; width:auto; height:auto; padding:4px; padding-left:16px; padding-right:16px; background-color:white; border-top-left-radius:.6em; border-top-right-radius:.6em; opacity:.8; filter:alpha(opacity=80); cursor:default;")
				- if (global.session.logged_in && recipe.owner == global.session.user.id)
					| Owned by You
				- else
					| Owned by 
					b(style="cursor:pointer;")
						| #{recipe.owner}

			style(type="text/css")
				div.star_power{width:#{recipe.rank / 10 * 168}px; height:100%; background-color:#ffbf00;}
				div.star_outline{width:168px; height:32px; margin:auto; position:relative; top:4px; margin-bottom:-32px; background-image:url('../images/star_hollow1.png'); cursor:pointer;}

			//- Rating
			div(style="width:168px; height:30px; margin:auto; position:relative; left:1px; top:6px; margin-bottom:-32px; padding-bottom:3px;")
				div.star_power
			div.star_outline(title="#{recipe.rank / 2}/5 stars (#{recipe.rank_count} ranks)")

			div(style="float:right; position:relative; top:22px; right:10px; font-size:12px; color:gray;")
				| Created on #{recipe.date_added.toDateString()}

		// Ingredients
		div(style="font-size:16px; height:auto; padding:10px; border:1px solid #c2c2c2; margin-bottom:10px; background-color:white; min-height:186px;")

			div(style="border-radius:.6em; float:right; position:relative; padding:6px; margin:6px;")
				div(style="font-size:16px; float:right; clear:both; text-align:center; width:100%;")
					| Serving Size
				div(style="font-size:18px; float:right; clear:both; text-align:center; width:100%; margin-bottom:6px;")
					| #{recipe.serving_size}

				div(style="font-size:16px; float:right; clear:both; border-top:1px dashed gray; width:100%; text-align:center; margin-top:4px; padding-top:10px;")
					| Prep Time
				div(style="font-size:18px; float:right; clear:both; text-align:center; width:100%; margin-bottom:6px;")
					| #{recipe.prep_time}

				div(style="font-size:16px; float:right; clear:both; border-top:1px dashed gray; width:100%; text-align:center; margin-top:4px; padding-top:10px;")
					| Ready in
				div(style="font-size:18px; float:right; clear:both; text-align:center; width:100%;")
					| #{recipe.ready_time}

			div(style="font-size:20px; background-color:white; width:100px; padding:2px;")
				| Ingredients
			table(style="margin-left:10px;")
				- for (var i = 0; i < (recipe.ingredients).length; i++)
					tr
						td(style="height:20px; padding-left:10px; padding-left:10px; padding-right:2px; margin:3px; text-align:right;")
							- if (recipe.ingredients[i].amount == .5)
								| 1/2
							- else if (recipe.ingredients[i].amount == .75)
								| 3/4
							- else if (recipe.ingredients[i].amount == .25)
								| 1/4
							- else if (recipe.ingredients[i].amount == .125)
								| 1/8
							- else if (recipe.ingredients[i].amount == .3333)
								| 1/3
							- else if (recipe.ingredients[i].amount == .6667)
								| 2/3
							- else
								| #{recipe.ingredients[i].amount} 
						td(style="padding-right:4px;")
							|  #{recipe.ingredients[i].unit_name} 
							b(style="cursor:pointer;")
								a(id="ingr#{recipe.ingredients[i].id}", href="", style="color:black; text-decoration:none;")
									| #{recipe.ingredients[i].name}

		//- Directions
		div(style="font-size:16px; height:auto; padding:10px; border:1px solid #c2c2c2; margin-bottom:10px; background-color:white;")
			div(style="font-size:20px; background-color:white; width:100px; padding:2px;")
				| Directions
			div(style="padding-left:10px;")
				- for direction in recipe.directions.split('\n')
					div(style="margin-top:6px; min-height:19px;")
						| #{direction}

		style(type="text/css")
			div.comment{padding:5px; padding-left:10px; margin:15px; margin-bottom:20px; margin-top:25px; border:1px solid gray; border-radius:.6em; height:auto; background-image:url('../images/comment_bg1.png'); background-size:100% 100%;}
			div.new_cancel{position:relative; top:-18px; right:100px; width:60px; margin-left:auto; border:2px dotted white; border-radius:.6em; padding:2px; padding-left:8px; padding-right:8px; margin-bottom:-20px; background-color:#b03f3f; color:white; font-weight:bold; text-align:center;}
			div.new_cancel:hover{cursor:pointer; background-color:#b35b5b;}
			div.new_post{position:relative; top:-7px; right:15px; width:60px; margin-left:auto; border:2px dotted white; border-radius:.6em; padding:2px; padding-left:8px; padding-right:8px; margin-bottom:-16px; background-color:#00a200; color:white; font-weight:bold; text-align:center;}
			div.new_post:hover{cursor:pointer; background-color:#44bd44;}

		//- Comments
		div(style="font-size:16px; height:auto; padding:10px; border:1px solid #c2c2c2; background-color:white;")
			div(style="font-size:20px; background-color:white; width:100px; padding:2px;")
				| Comments

			div(style="padding:5px; padding-top:1px; padding-bottom:1px; border-radius:.6em;", id="comments")
				- for(var i = 0; i < recipe.flat_comments.length; i++)
					- comment = recipe.flat_comments[i];
					- if (recipe.owner == comment.owner)
						- comment_color = 'e8f0ff';
					- else
						- comment_color = 'ffffff';

					div.comment(style="margin-left:#{comment.indent * 50 + 30}px; background-color:##{comment_color};", id="comment#{comment.id}")

						//- User stuff
						div(style="position:relative; top:-25px; margin:-6px; margin-left:-10px; margin-bottom:-36px; padding:5px;")
							
							div(style="padding:5px; margin-right:10px; text-align:center; position:relative; left:-32px; top:14px; margin-bottom:-24px; margin-right:-24px; border:1px solid gray; border-radius:.6em; width:64px; background-color:##{comment_color};")
								div(style="width:64px; height:64px; overflow:hidden;")
									img(style="width:100%;", src="../images/user_images/#{comment.picture.location}", alt="#{comment.picture.caption}", title="#{comment.picture.caption}")

						div(style="height:20px; margin-left:45px; margin-right:10px; position:relative; top:-20px; margin-bottom:-20px;")
							div(style="color:gray;")
								- if (global.session.logged_in && comment.owner == global.session.user.id)
									| You 
								- else
									p(style="margin:0px; padding:0px; cursor:pointer;")
										| #{comment.owner} 

							div(style="font-size:12px; color:gray; float:right; position:relative; top:-16px;")
								| #{comment.date_added.toDateString()} at 
								- if (comment.date_added.getHours() > 12)
									| #{comment.date_added.getHours() - 12}
								- else
									| #{comment.date_added.getHours()}
								| :
								- if (comment.date_added.getMinutes() < 10)
									| 0
								| #{comment.date_added.getMinutes()}:
								- if (comment.date_added.getSeconds() < 10)
									| 0
								| #{comment.date_added.getSeconds()}
								- if (comment.date_added.getHours() > 12)
									|  pm
								- else
									|  am

						div(style="margin-right:5px; margin-left:40px; border:1px solid border-top:1px solid #dedede; border-radius:.2em; padding:4px; padding-top:10px; padding-left:5px; padding-right:5px;")
							- for piece in comment.content.split('\n')
								div(style="margin-top:2px; min-height:19px;")
									| #{piece}

						- if (global.session.logged_in && global.session.user.id != comment.owner)
							div(style="background-image:url('../images/reply1.png'); width:59px; height:24px; margin-left:auto; cursor:pointer; position:relative; top:3px; margin-bottom:-20px; z-index:1;", title="Reply to #{comment.owner}'s comment.", id="reply#{comment.id}")

				- if (global.session.logged_in)
					// New comment box (hides on load)			
					- if (recipe.owner == global.session.user.id)
						- comment_color = 'e8f0ff';
					- else
						- comment_color = 'ffffff';
					div.comment(style="margin-left:30px; background-color:##{comment_color};", id="new_comment")

						//- User stuff
						div(style="padding:5px; margin-right:10px; text-align:center; position:relative; left:-36px; top:-12px; margin-bottom:-24px; margin-right:-24px; border:1px solid gray; border-radius:.6em; width:64px; background-color:##{comment_color};")
								div(style="width:64px; height:64px; overflow:hidden;")
									img(style="width:100%;", src="../images/user_images/#{global.session.user.picture.location}", alt="#{global.session.user.picture.caption}", title="#{comment.picture.caption}")

						div(style="font-size:12px; color:gray; position:relative; left:46px; top:-50px; margin-bottom:-16px; width:260px;")

						div(style="color:gray; position:relative; top:-50px; left:50px; margin-bottom:-50px; width:200px;")
							| What will you say?

						form(style="margin:0px; padding:0px;", method="post", action="/recipe/comment_on")

							div(style="margin-left:45px; margin-right:15px; border-top:1px solid #dedede; border-radius:.2em; padding:4px; padding-left:5px; padding-right:5px;")
								textarea.input_text(style="width:100%; max-width:100%;", type="text", name="comment_content", id="new_comment_text")

							input(type="hidden", name="reply_comment", value="0")
							input(id="new_reply_target_id", type="hidden", name="recipe_id", value="#{recipe.id}")

							div.new_post(id="new_comment_post", title="Click here to post your comment.", onClick="this.parentNode.submit();")
								| Post

							div.new_cancel(id="new_comment_cancel", title="Click here to cancel your comment.")
								| Cancel

					// New reply box (hides on load)			
					- if (recipe.owner == global.session.user.id)
						- comment_color = 'e8f0ff';
					- else
						- comment_color = 'ffffff';
					div.comment(style="margin-left:30px; background-color:##{comment_color};", id="new_reply")

						//- User stuff
						div(style="padding:5px; margin-right:10px; text-align:center; position:relative; left:-36px; top:-12px; margin-bottom:-24px; margin-right:-24px; border:1px solid gray; border-radius:.6em; width:64px; background-color:##{comment_color};")
								div(style="width:64px; height:64px; overflow:hidden;")
									img(style="width:100%;", src="../images/user_images/#{global.session.user.picture.location}", alt="#{global.session.user.picture.caption}", title="#{comment.picture.caption}")

						div(style="color:gray; position:relative; top:-50px; left:50px; margin-bottom:-50px; width:200px;")
							| What will you say?

						form(style="margin:0px; padding:0px;", method="post", action="/recipe/comment_on")

							div(style="margin-left:45px; margin-right:15px; border-top:1px solid #dedede; border-radius:.2em; padding:4px; padding-left:5px; padding-right:5px;")
								textarea.input_text(style="width:100%; max-width:100%;", type="text", name="comment_content", id="new_reply_text")

							input(id="new_reply_target_id", type="hidden", name="reply_comment")
							input(id="new_reply_target_id", type="hidden", name="recipe_id", value="#{recipe.id}")

							div.new_post(id="new_reply_post", title="Click here to post your reply.", onClick="this.parentNode.submit();")
								| Post

							div.new_cancel(id="new_reply_cancel", title="Click here to cancel your reply.")
								| Cancel

		- if (global.session.logged_in)
			div(style="background-image:url('../images/comment1.png'); width:120px; height:26px; margin:auto; cursor:pointer; position:relative; top:-5px;", title="Comment on this recipe.", id="new_comment_button")

	script(src="../jquery.js")
	script
		var resizing_image = false;
		var image_index = 0;
		var images = [#{recipe.pictures_string().toString()}];
		var ingredients = [#{recipe.ingredients_string().toString()}];
		$(document).ready(function()
		{
			$("#new_comment").hide();
			$("#new_reply").hide();
			$("#new_comment_button").click(function(){
				$("#new_comment_button").hide();
				$("#new_comment").slideDown();
				$("#new_comment_text").focus();
				$("[id^=reply]").slideUp();
				$("html, body").animate({ scrollTop: $(document).height() + $("#new_comment").position().top }, "slow");
 
			});
			$("#new_comment_cancel").click(function(){
				$("#new_comment").slideUp();
				$("#new_comment_button").show();
				$("[id^=reply]").slideDown();
			});
			$("[id^=reply]").click(function(){
				$("[id^=reply]").slideUp();
				$("#new_reply").insertAfter($(event.target).parent());
				var parent = $(event.target).parent();
				$("#new_reply").css('margin-left', (parseInt(parent.css('margin-left')) + 50).toString() + 'px');
				$("#new_reply").slideDown();
				$("#new_reply_text").focus();
				$("#new_reply_target_id").val(this.id.match(/[0-9]+/g));
				$("#new_comment_button").hide();
			});
			$("#new_reply_cancel").click(function(){
				$("#new_reply").slideUp();
				$("[id^=reply]").slideDown();
				$("#new_comment_button").show();
			});
			$("#recipe_pic_drag").mousedown(function(e)
			{
				e.preventDefault();
				resizing_image = true;
				$(document).mousemove(function(e){
					if (resizing_image)
					{
						$("#recipe_photo_div").css('height', e.pageY-54);
						if ($("#recipe_photo_div").height() > $("#recipe_photo").height())
							$("#recipe_photo_div").css('height', $("#recipe_photo").height());
					}
				});
			});
			$("#recipe_pic_drag").dblclick(function()
			{
				$("#recipe_photo_div").css('height', $("#recipe_photo_div").css('min-height'));
			});
			$(document).mouseup(function(e){
				resizing_image = false;
			});
			if (images.length <= 1)
			{
				$("#recipe_pic_prev").hide();
				$("#recipe_pic_next").hide();
			}
			// Ingredient hover stuff
			$("[id^=ingr]").hover(function(e){
				var ingr_num = event.target.id.match(/[0-9]+/g);
				var index = 0;
				for (var i = 0; i < ingredients.length; i++)
				{
					if (ingredients[i].id == ingr_num)
						index = i;
				}
				$("<div></div>").attr({id:'ingr_float', style:'float:left; position:absolute; left:'+(e.pageX + 16)+'px; top:'+e.pageY+'px; min-width:180px; background-color:white; border:1px solid #c2c2c2; z-index:2;'}).appendTo('body');
				$("<div></div>").attr({id:'ingr_float_image_div', style: "overflow:hidden; width:48px; height:48px; margin:4px; float:left;"}).appendTo('#ingr_float');
				$("<img>").attr({src: "../images/user_images/" + ingredients[index].picture_location, style: "width:100%;"}).appendTo("#ingr_float_image_div");
				$("<div>" + ingredients[index].name + "</div>").attr({style: "white-space:nowrap; float:left; margin:4px; margin-right:10px;"}).appendTo("#ingr_float");
				$("<div>" + ingredients[index].use_count + "</div>").attr({style: "color:blue; font-size:10px; float:right; clear:both; margin:4px; margin-right:14px; margin-top:-18px; position:relative; top:-14px;"}).appendTo("#ingr_float");
				$("<div>Click to learn more.</div>").attr({style: "white-space:nowrap; color:gray; font-size:12px; float:right; clear:both; margin:4px; margin-right:10px; margin-top:-18px;"}).appendTo("#ingr_float");
			}, function(e){
				$("#ingr_float").remove();
			});
			$("[id^=ingr]").mousemove(function(e){
				$("#ingr_float").css({left: (e.pageX + 16) + 'px', top: e.pageY + 'px'});
			});
		});
		function prev_picture()
		{
			$("#recipe_photo").fadeOut(200, function()
				{
					image_index -= 1;
					if (image_index < 0)
						image_index = images.length - 1;
					$("#recipe_photo").attr('src', "../images/user_images/" + images[image_index].location);
					$("#recipe_photo").attr('title', images[image_index].caption);
					$("#recipe_photo").fadeIn(200);
					// refresh_picture gets called when the image has loaded... see image declaration above
				});
		}
		function next_picture()
		{
			$("#recipe_photo").fadeOut(200, function()
				{
					image_index += 1;
					if (image_index >= images.length)
						image_index = 0;
					$("#recipe_photo").attr('src', "../images/user_images/" + images[image_index].location);
					$("#recipe_photo").attr('title', images[image_index].caption);
					$("#recipe_photo").fadeIn(200);
					// refresh_picture gets called when the image has loaded... see image declaration above
				});
		}
		function refresh_picture()
		{
			if ($("#recipe_photo_div").height() > $("#recipe_photo").height())
				$("#recipe_photo_div").css('height', $("#recipe_photo").height());
		}

	include ../footer